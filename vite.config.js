import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';
import autoprefixer from 'autoprefixer';
import path from 'path';
import fs from 'fs';
import handlebars from 'handlebars';
import { nodePolyfills } from 'vite-plugin-node-polyfills';

const pages = {"index":{"outputDir":"./","lang":"en","title":"","cacheVersion":24,"meta":[{"name":"twitter:card","content":"summary"},{"property":"og:type","content":"website"},{"name":"robots","content":"index, follow"}],"scripts":{"head":"<style>\n.iosRounded {\n\t\tclip-path: polygon( 50.05% 0%,50.05% 0%,51.762% 0.006%,53.473% 0.026%,55.182% 0.062%,56.89% 0.115%,58.596% 0.188%,60.299% 0.281%,61.998% 0.397%,63.692% 0.538%,65.382% 0.705%,67.067% 0.901%,67.067% 0.901%,68.418% 1.063%,69.768% 1.252%,71.116% 1.47%,72.46% 1.719%,73.799% 2.002%,75.132% 2.321%,76.458% 2.678%,77.775% 3.076%,79.083% 3.517%,80.38% 4.004%,80.38% 4.004%,82.786% 5.022%,85.018% 6.21%,87.077% 7.567%,88.963% 9.089%,90.678% 10.773%,92.222% 12.617%,93.595% 14.616%,94.798% 16.769%,95.832% 19.072%,96.697% 21.522%,96.697% 21.522%,97.154% 22.999%,97.566% 24.488%,97.935% 25.987%,98.266% 27.497%,98.561% 29.017%,98.823% 30.545%,99.055% 32.082%,99.259% 33.626%,99.44% 35.178%,99.6% 36.737%,99.6% 36.737%,99.735% 38.481%,99.843% 40.231%,99.926% 41.984%,99.986% 43.739%,100.025% 45.495%,100.046% 47.252%,100.052% 49.007%,100.045% 50.76%,100.027% 52.51%,100% 54.254%,100% 54.254%,99.957% 56.476%,99.883% 58.696%,99.772% 60.913%,99.617% 63.124%,99.412% 65.328%,99.15% 67.523%,98.824% 69.707%,98.427% 71.878%,97.954% 74.035%,97.397% 76.176%,97.397% 76.176%,97.115% 77.221%,96.807% 78.253%,96.473% 79.273%,96.111% 80.278%,95.721% 81.269%,95.3% 82.245%,94.848% 83.205%,94.364% 84.149%,93.846% 85.076%,93.293% 85.986%,93.293% 85.986%,92.42% 87.239%,91.482% 88.416%,90.482% 89.522%,89.421% 90.559%,88.301% 91.529%,87.124% 92.436%,85.892% 93.284%,84.606% 94.074%,83.269% 94.81%,81.882% 95.495%,81.882% 95.495%,80.765% 95.955%,79.637% 96.376%,78.5% 96.761%,77.354% 97.113%,76.201% 97.435%,75.042% 97.73%,73.878% 98.001%,72.711% 98.25%,71.541% 98.482%,70.37% 98.699%,70.37% 98.699%,67.728% 99.078%,65.084% 99.382%,62.44% 99.617%,59.793% 99.791%,57.145% 99.912%,54.493% 99.989%,51.838% 100.028%,49.178% 100.038%,46.514% 100.026%,43.844% 100%,43.844% 100%,42.643% 99.94%,41.441% 99.877%,40.24% 99.812%,39.039% 99.741%,37.838% 99.662%,36.637% 99.575%,35.435% 99.477%,34.234% 99.366%,33.033% 99.241%,31.832% 99.099%,31.832% 99.099%,30.331% 98.873%,28.832% 98.615%,27.338% 98.32%,25.851% 97.986%,24.374% 97.61%,22.909% 97.189%,21.459% 96.72%,20.025% 96.2%,18.61% 95.626%,17.217% 94.995%,17.217% 94.995%,15.667% 94.202%,14.201% 93.326%,12.815% 92.367%,11.511% 91.326%,10.285% 90.203%,9.138% 88.999%,8.067% 87.714%,7.073% 86.35%,6.152% 84.906%,5.305% 83.383%,5.305% 83.383%,4.791% 82.356%,4.326% 81.318%,3.905% 80.269%,3.524% 79.21%,3.178% 78.141%,2.862% 77.063%,2.571% 75.976%,2.301% 74.882%,2.046% 73.781%,1.802% 72.673%,1.802% 72.673%,1.516% 71.171%,1.26% 69.669%,1.033% 68.165%,0.834% 66.66%,0.663% 65.153%,0.519% 63.642%,0.401% 62.128%,0.309% 60.609%,0.242% 59.086%,0.2% 57.558%,0.2% 57.558%,0.143% 56.356%,0.093% 55.155%,0.05% 53.954%,0.014% 52.753%,-0.013% 51.552%,-0.03% 50.35%,-0.039% 49.149%,-0.037% 47.948%,-0.024% 46.747%,-0% 45.546%,0% 45.546%,0.067% 43.566%,0.151% 41.593%,0.259% 39.624%,0.394% 37.659%,0.563% 35.698%,0.771% 33.74%,1.024% 31.784%,1.326% 29.831%,1.684% 27.878%,2.102% 25.926%,2.102% 25.926%,2.322% 24.971%,2.56% 24.026%,2.819% 23.092%,3.1% 22.165%,3.403% 21.246%,3.731% 20.333%,4.084% 19.425%,4.463% 18.52%,4.87% 17.618%,5.305% 16.717%,5.305% 16.717%,6.188% 15.113%,7.155% 13.603%,8.206% 12.186%,9.341% 10.86%,10.561% 9.622%,11.864% 8.472%,13.251% 7.407%,14.723% 6.425%,16.278% 5.525%,17.918% 4.705%,17.918% 4.705%,18.825% 4.302%,19.742% 3.932%,20.669% 3.592%,21.605% 3.279%,22.548% 2.99%,23.496% 2.723%,24.45% 2.473%,25.407% 2.238%,26.367% 2.016%,27.327% 1.802%,27.327% 1.802%,29.582% 1.365%,31.843% 1.009%,34.108% 0.725%,36.378% 0.505%,38.651% 0.338%,40.927% 0.216%,43.206% 0.131%,45.486% 0.072%,47.768% 0.032%,50.05% 0% );\n\t}\n</style>\n","body":"\n"},"baseTag":{"href":"/","target":"_self"},"alternateLinks":[{"rel":"alternate","hreflang":"x-default","href":"https://595841db-6612-4249-af46-8bfd9169fa6e.weweb-preview.io/"},{"rel":"alternate","hreflang":"en","href":"https://595841db-6612-4249-af46-8bfd9169fa6e.weweb-preview.io/"}]},"project/:param":{"outputDir":"./project/:param","lang":"en","title":"","cacheVersion":24,"meta":[{"name":"twitter:card","content":"summary"},{"property":"og:type","content":"website"},{"name":"robots","content":"index, follow"}],"scripts":{"head":"<style>\n.iosRounded {\n\t\tclip-path: polygon( 50.05% 0%,50.05% 0%,51.762% 0.006%,53.473% 0.026%,55.182% 0.062%,56.89% 0.115%,58.596% 0.188%,60.299% 0.281%,61.998% 0.397%,63.692% 0.538%,65.382% 0.705%,67.067% 0.901%,67.067% 0.901%,68.418% 1.063%,69.768% 1.252%,71.116% 1.47%,72.46% 1.719%,73.799% 2.002%,75.132% 2.321%,76.458% 2.678%,77.775% 3.076%,79.083% 3.517%,80.38% 4.004%,80.38% 4.004%,82.786% 5.022%,85.018% 6.21%,87.077% 7.567%,88.963% 9.089%,90.678% 10.773%,92.222% 12.617%,93.595% 14.616%,94.798% 16.769%,95.832% 19.072%,96.697% 21.522%,96.697% 21.522%,97.154% 22.999%,97.566% 24.488%,97.935% 25.987%,98.266% 27.497%,98.561% 29.017%,98.823% 30.545%,99.055% 32.082%,99.259% 33.626%,99.44% 35.178%,99.6% 36.737%,99.6% 36.737%,99.735% 38.481%,99.843% 40.231%,99.926% 41.984%,99.986% 43.739%,100.025% 45.495%,100.046% 47.252%,100.052% 49.007%,100.045% 50.76%,100.027% 52.51%,100% 54.254%,100% 54.254%,99.957% 56.476%,99.883% 58.696%,99.772% 60.913%,99.617% 63.124%,99.412% 65.328%,99.15% 67.523%,98.824% 69.707%,98.427% 71.878%,97.954% 74.035%,97.397% 76.176%,97.397% 76.176%,97.115% 77.221%,96.807% 78.253%,96.473% 79.273%,96.111% 80.278%,95.721% 81.269%,95.3% 82.245%,94.848% 83.205%,94.364% 84.149%,93.846% 85.076%,93.293% 85.986%,93.293% 85.986%,92.42% 87.239%,91.482% 88.416%,90.482% 89.522%,89.421% 90.559%,88.301% 91.529%,87.124% 92.436%,85.892% 93.284%,84.606% 94.074%,83.269% 94.81%,81.882% 95.495%,81.882% 95.495%,80.765% 95.955%,79.637% 96.376%,78.5% 96.761%,77.354% 97.113%,76.201% 97.435%,75.042% 97.73%,73.878% 98.001%,72.711% 98.25%,71.541% 98.482%,70.37% 98.699%,70.37% 98.699%,67.728% 99.078%,65.084% 99.382%,62.44% 99.617%,59.793% 99.791%,57.145% 99.912%,54.493% 99.989%,51.838% 100.028%,49.178% 100.038%,46.514% 100.026%,43.844% 100%,43.844% 100%,42.643% 99.94%,41.441% 99.877%,40.24% 99.812%,39.039% 99.741%,37.838% 99.662%,36.637% 99.575%,35.435% 99.477%,34.234% 99.366%,33.033% 99.241%,31.832% 99.099%,31.832% 99.099%,30.331% 98.873%,28.832% 98.615%,27.338% 98.32%,25.851% 97.986%,24.374% 97.61%,22.909% 97.189%,21.459% 96.72%,20.025% 96.2%,18.61% 95.626%,17.217% 94.995%,17.217% 94.995%,15.667% 94.202%,14.201% 93.326%,12.815% 92.367%,11.511% 91.326%,10.285% 90.203%,9.138% 88.999%,8.067% 87.714%,7.073% 86.35%,6.152% 84.906%,5.305% 83.383%,5.305% 83.383%,4.791% 82.356%,4.326% 81.318%,3.905% 80.269%,3.524% 79.21%,3.178% 78.141%,2.862% 77.063%,2.571% 75.976%,2.301% 74.882%,2.046% 73.781%,1.802% 72.673%,1.802% 72.673%,1.516% 71.171%,1.26% 69.669%,1.033% 68.165%,0.834% 66.66%,0.663% 65.153%,0.519% 63.642%,0.401% 62.128%,0.309% 60.609%,0.242% 59.086%,0.2% 57.558%,0.2% 57.558%,0.143% 56.356%,0.093% 55.155%,0.05% 53.954%,0.014% 52.753%,-0.013% 51.552%,-0.03% 50.35%,-0.039% 49.149%,-0.037% 47.948%,-0.024% 46.747%,-0% 45.546%,0% 45.546%,0.067% 43.566%,0.151% 41.593%,0.259% 39.624%,0.394% 37.659%,0.563% 35.698%,0.771% 33.74%,1.024% 31.784%,1.326% 29.831%,1.684% 27.878%,2.102% 25.926%,2.102% 25.926%,2.322% 24.971%,2.56% 24.026%,2.819% 23.092%,3.1% 22.165%,3.403% 21.246%,3.731% 20.333%,4.084% 19.425%,4.463% 18.52%,4.87% 17.618%,5.305% 16.717%,5.305% 16.717%,6.188% 15.113%,7.155% 13.603%,8.206% 12.186%,9.341% 10.86%,10.561% 9.622%,11.864% 8.472%,13.251% 7.407%,14.723% 6.425%,16.278% 5.525%,17.918% 4.705%,17.918% 4.705%,18.825% 4.302%,19.742% 3.932%,20.669% 3.592%,21.605% 3.279%,22.548% 2.99%,23.496% 2.723%,24.45% 2.473%,25.407% 2.238%,26.367% 2.016%,27.327% 1.802%,27.327% 1.802%,29.582% 1.365%,31.843% 1.009%,34.108% 0.725%,36.378% 0.505%,38.651% 0.338%,40.927% 0.216%,43.206% 0.131%,45.486% 0.072%,47.768% 0.032%,50.05% 0% );\n\t}\n</style>\n","body":"\n"},"baseTag":{"href":"/","target":"_self"},"alternateLinks":[{"rel":"alternate","hreflang":"x-default","href":"https://595841db-6612-4249-af46-8bfd9169fa6e.weweb-preview.io/project/:param/"},{"rel":"alternate","hreflang":"en","href":"https://595841db-6612-4249-af46-8bfd9169fa6e.weweb-preview.io/project/:param/"}]}};

// Read the main HTML template
const template = fs.readFileSync(path.resolve(__dirname, 'template.html'), 'utf-8');
const compiledTemplate = handlebars.compile(template);

// Generate an HTML file for each page with its metadata
Object.values(pages).forEach(pageConfig => {
    // Compile the template with page metadata
    const html = compiledTemplate({
        title: pageConfig.title,
        lang: pageConfig.lang,
        meta: pageConfig.meta,
        structuredData: pageConfig.structuredData || null,
        scripts: {
            head: pageConfig.scripts.head,
            body: pageConfig.scripts.body,
        },
        alternateLinks: pageConfig.alternateLinks,
        cacheVersion: pageConfig.cacheVersion,
        baseTag: pageConfig.baseTag,
    });

    // Save output html for each page
    if (!fs.existsSync(pageConfig.outputDir)) {
        fs.mkdirSync(pageConfig.outputDir, { recursive: true });
    }
    fs.writeFileSync(`${pageConfig.outputDir}/index.html`, html);
});

const rollupOptionsInput = {};
for (const pageName in pages) {
    rollupOptionsInput[pageName] = path.resolve(__dirname, pages[pageName].outputDir, 'index.html');
}

export default defineConfig(() => {
    return {
        plugins: [nodePolyfills({ include: ['events', 'stream', 'string_decoder'] }), vue()],
        base: "/",
        resolve: {
            alias: {
                '@': path.resolve(__dirname, './src'),
            },
        },
        css: {
            preprocessorOptions: {
                scss: {
                    api: 'modern-compiler',
                },
            },
            postcss: {
                plugins: [autoprefixer],
            },
        },
        build: {
            chunkSizeWarningLimit: 10000,
            rollupOptions: {
                input: rollupOptionsInput,
                onwarn: (entry, next) => {
                    if (entry.loc?.file && /js$/.test(entry.loc.file) && /Use of eval in/.test(entry.message)) return;
                    return next(entry);
                },
                maxParallelFileOps: 900,
            },
        },
        logLevel: 'warn',
    };
});
